# Telegram Assistant (wookiee-ai-assistant)

Кратко: Telegram-бот для управления задачами и календарем Bitrix24, хранилище — Supabase, интеграция через входящий вебхук Bitrix24. Базовый план и чек-листы лежат в `wookiee_ai_assistent/` (README, CHECKLIST_PREPARE, SECRETS_SETUP, план архитектуры).

## Архитектура (текстовая схема)
Telegram → FastAPI webhook (`/webhook/telegram`) + aiogram router → сервисы:
- `packages/bitrix_client`: обертка Bitrix24 REST (webhook URL, retry, логирование)
- `packages/supabase_db`: доступ к таблицам (users/auth_codes/tasks_cache/events_cache/sync_state/notification_outbox)
- `packages/llm_orchestrator`: разбор естественного языка для создания задач/событий (через OpenRouter/OpenAI/Claude, по возможности)
Фоновые операции: Vercel Cron/GitHub Actions вызывают защищенные endpoints (`/jobs/morning_digest`, `/jobs/weekly_digest`) с `CRON_SECRET`. Healthcheck: `/health`.

## Планируемая раскладка в монорепо
- `apps/telegram_assistant/` — сервис бота (FastAPI + aiogram)
- `packages/bitrix_client/` — клиент Bitrix24 + модели
- `packages/supabase_db/` — миграции/DDL + typed клиент
- `packages/llm_orchestrator/` — prompts/tools для NL→структура и планов дня
- `infra/vercel/` — конфигурация деплоя/cron (при необходимости)

## Переменные окружения (MVP)
- `TELEGRAM_BOT_TOKEN` — токен бота
- `BITRIX24_WEBHOOK` — полный URL incoming webhook
- `SUPABASE_URL` — URL проекта
- `SUPABASE_SERVICE_ROLE_KEY` — service-role ключ (только сервер/cron)
- `DEFAULT_TIMEZONE` — `Europe/Moscow` по умолчанию
- `CRON_SECRET` — токен для защиты cron endpoints
- `OPENROUTER_API_KEY` или `OPENAI_API_KEY` (если включаем LLM)
- `APP_BASE_URL` — публичный URL webhook’а (Vercel / туннель)

## Черновик схемы БД (Supabase, схему назвать `assistant`)
```sql
-- Пользователи и привязка
CREATE TABLE assistant.users (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  telegram_id bigint NOT NULL,
  telegram_chat_id bigint NOT NULL,
  bitrix_user_id bigint NOT NULL,
  email text NOT NULL,
  timezone text NOT NULL DEFAULT 'Europe/Moscow',
  notifications_enabled boolean NOT NULL DEFAULT true,
  morning_time time NOT NULL DEFAULT '08:00',
  evening_time time NOT NULL DEFAULT '18:00',
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now(),
  UNIQUE (telegram_id),
  UNIQUE (email)
);

-- Одноразовые коды подтверждения
CREATE TABLE assistant.auth_codes (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  telegram_id bigint NOT NULL,
  email text NOT NULL,
  code_hash text NOT NULL,
  expires_at timestamptz NOT NULL,
  attempts smallint NOT NULL DEFAULT 0,
  created_at timestamptz NOT NULL DEFAULT now()
);

-- Кэш задач Bitrix (для дайджестов/overdue)
CREATE TABLE assistant.tasks_cache (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  bitrix_task_id bigint NOT NULL,
  bitrix_user_id bigint NOT NULL,
  title text NOT NULL,
  status text NOT NULL,
  deadline timestamptz,
  updated_at timestamptz,
  raw_payload jsonb,
  UNIQUE (bitrix_task_id)
);

-- Кэш событий
CREATE TABLE assistant.events_cache (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  bitrix_event_id bigint NOT NULL,
  bitrix_user_id bigint NOT NULL,
  title text NOT NULL,
  start_at timestamptz NOT NULL,
  end_at timestamptz NOT NULL,
  updated_at timestamptz,
  raw_payload jsonb,
  UNIQUE (bitrix_event_id)
);

-- Состояние синка
CREATE TABLE assistant.sync_state (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  bitrix_user_id bigint NOT NULL,
  entity_type text NOT NULL CHECK (entity_type IN ('task','event','user')),
  last_synced_at timestamptz,
  UNIQUE (bitrix_user_id, entity_type)
);

-- Идемпотентность уведомлений/дайджестов
CREATE TABLE assistant.notification_outbox (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  dedupe_key text NOT NULL,
  telegram_chat_id bigint NOT NULL,
  payload jsonb NOT NULL,
  sent_at timestamptz NOT NULL DEFAULT now(),
  UNIQUE (dedupe_key)
);
```
Индексы: добавить по `bitrix_user_id`, `deadline`, `start_at` для выборок; RLS включать после появления сервисных ролей и политики доступа.

## Минимальный вертикальный срез (Phase 2 старт)
1) Поднять FastAPI + aiogram с командами `/start`, `/help`, `/today`.  
2) Интегрировать `packages/bitrix_client` (webhook URL) и вытянуть задачи пользователя (`tasks.task.list`/`tasks.task.get`) с фильтром по дедлайнам.  
3) Записать задачи в `assistant.tasks_cache`, обновить `sync_state`.  
4) Ответить пользователю дайджестом «сегодня/просрочено».  
5) Добавить cron endpoint `morning_digest` с `CRON_SECRET`.

## Деплой на Vercel (Hobby)

### 1. Настройка переменных окружения

В Vercel Dashboard → Project → Settings → Environment Variables добавьте:
- `TELEGRAM_BOT_TOKEN` — токен бота от @BotFather
- `BITRIX24_WEBHOOK` — полный URL incoming webhook из Bitrix24
- `SUPABASE_URL` — URL проекта Supabase
- `SUPABASE_SERVICE_ROLE_KEY` — service-role ключ Supabase
- `CRON_SECRET` — случайный секрет для защиты cron endpoints
- `DEFAULT_TIMEZONE` — `Europe/Moscow` (или другая)
- `APP_BASE_URL` — публичный URL вашего Vercel проекта (например, `https://wookiee-dashboard.vercel.app`)

### 2. Настройка Telegram Webhook

После деплоя на Vercel настройте webhook в Telegram:

```bash
# Замените YOUR_BOT_TOKEN и YOUR_VERCEL_URL на реальные значения
curl -X POST "https://api.telegram.org/botYOUR_BOT_TOKEN/setWebhook" \
  -d "url=https://YOUR_VERCEL_URL/webhook/telegram"
```

Проверить статус webhook:
```bash
curl "https://api.telegram.org/botYOUR_BOT_TOKEN/getWebhookInfo"
```

Удалить webhook (если нужно):
```bash
curl -X POST "https://api.telegram.org/botYOUR_BOT_TOKEN/deleteWebhook"
```

### 3. Проверка работы

1. Проверьте health endpoint: `https://YOUR_VERCEL_URL/health` (должен вернуть `{"status":"ok"}`)
2. Отправьте боту команду `/start your@email.com` в Telegram
3. Проверьте логи в Vercel Dashboard → Deployments → Functions → View Function Logs

### 4. Cron задачи

Cron задачи настраиваются через GitHub Actions (см. `.github/workflows/morning_digest.yml`, `.github/workflows/evening_digest.yml`), секреты в репо: `CRON_SECRET`, `APP_BASE_URL`.

### 5. Структура роутинга

`vercel.json` роутит:
- `/health` → `api/index.py`
- `/webhook/telegram` → `api/index.py`
- `/jobs/morning_digest` → `api/index.py`
- `/jobs/evening_digest` → `api/index.py`

Все запросы обрабатываются через FastAPI `app` из `apps/telegram_assistant/main.py`.

## Команды бота (MVP)
- `/start <email>` — отправляет OTP в Bitrix24 (`im.notify`), ждёт `/code <otp>`.
- `/code <otp>` — подтверждает и привязывает Telegram ↔ Bitrix.
- `/today` — задачи на сегодня, просроченные, события на сегодня.
- `/help` — справка.

## Крон-задачи
- `/jobs/morning_digest` (08:00 Asia/Makassar, триггерится GitHub Actions) — шлёт дайджест по пользователям.
- `/jobs/evening_digest` (18:00 Asia/Makassar) — вечерний дайджест.

## Ссылки на исходные материалы
- `wookiee_ai_assistent/README.md`
- `wookiee_ai_assistent/CHECKLIST_PREPARE.md`
- `wookiee_ai_assistent/SECRETS_SETUP.md`
- `wookiee_ai_assistent/план_архитектуры_и_структуры_бота-помощника_для_bitrix24_440bcdf6.plan.md`

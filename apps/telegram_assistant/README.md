# Telegram Assistant (wookiee-ai-assistant)

–ö—Ä–∞—Ç–∫–æ: Telegram-–±–æ—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∞–º–∏ –∏ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–º Bitrix24, —Ö—Ä–∞–Ω–∏–ª–∏—â–µ ‚Äî Supabase, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ –≤—Ö–æ–¥—è—â–∏–π –≤–µ–±—Ö—É–∫ Bitrix24. –ë–∞–∑–æ–≤—ã–π –ø–ª–∞–Ω –∏ —á–µ–∫-–ª–∏—Å—Ç—ã –ª–µ–∂–∞—Ç –≤ `wookiee_ai_assistent/` (README, CHECKLIST_PREPARE, SECRETS_SETUP, –ø–ª–∞–Ω –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã).

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (—Ç–µ–∫—Å—Ç–æ–≤–∞—è —Å—Ö–µ–º–∞)
Telegram ‚Üí FastAPI webhook (`/webhook/telegram`) + aiogram router ‚Üí —Å–µ—Ä–≤–∏—Å—ã:
- `packages/bitrix_client`: –æ–±–µ—Ä—Ç–∫–∞ Bitrix24 REST (webhook URL, retry, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ)
- `packages/supabase_db`: –¥–æ—Å—Ç—É–ø –∫ —Ç–∞–±–ª–∏—Ü–∞–º (users/auth_codes/tasks_cache/events_cache/sync_state/notification_outbox)
- `packages/llm_orchestrator`: —Ä–∞–∑–±–æ—Ä –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á/—Å–æ–±—ã—Ç–∏–π (—á–µ—Ä–µ–∑ OpenRouter/OpenAI/Claude, –ø–æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏)
–§–æ–Ω–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏: Vercel Cron/GitHub Actions –≤—ã–∑—ã–≤–∞—é—Ç –∑–∞—â–∏—â–µ–Ω–Ω—ã–µ endpoints (`/jobs/morning_digest`, `/jobs/weekly_digest`) —Å `CRON_SECRET`. Healthcheck: `/health`.

## –ü–ª–∞–Ω–∏—Ä—É–µ–º–∞—è —Ä–∞—Å–∫–ª–∞–¥–∫–∞ –≤ –º–æ–Ω–æ—Ä–µ–ø–æ
- `apps/telegram_assistant/` ‚Äî —Å–µ—Ä–≤–∏—Å –±–æ—Ç–∞ (FastAPI + aiogram)
- `packages/bitrix_client/` ‚Äî –∫–ª–∏–µ–Ω—Ç Bitrix24 + –º–æ–¥–µ–ª–∏
- `packages/supabase_db/` ‚Äî –º–∏–≥—Ä–∞—Ü–∏–∏/DDL + typed –∫–ª–∏–µ–Ω—Ç
- `packages/llm_orchestrator/` ‚Äî prompts/tools –¥–ª—è NL‚Üí—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ –ø–ª–∞–Ω–æ–≤ –¥–Ω—è
- `infra/vercel/` ‚Äî –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–µ–ø–ª–æ—è/cron (–ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (MVP)
- `TELEGRAM_BOT_TOKEN` ‚Äî —Ç–æ–∫–µ–Ω –±–æ—Ç–∞
- `BITRIX24_WEBHOOK` ‚Äî –ø–æ–ª–Ω—ã–π URL incoming webhook
- `SUPABASE_URL` ‚Äî URL –ø—Ä–æ–µ–∫—Ç–∞
- `SUPABASE_SERVICE_ROLE_KEY` ‚Äî service-role –∫–ª—é—á (—Ç–æ–ª—å–∫–æ —Å–µ—Ä–≤–µ—Ä/cron)
- `DEFAULT_TIMEZONE` ‚Äî `Europe/Moscow` –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
- `CRON_SECRET` ‚Äî —Ç–æ–∫–µ–Ω –¥–ª—è –∑–∞—â–∏—Ç—ã cron endpoints
- `OPENROUTER_API_KEY` –∏–ª–∏ `OPENAI_API_KEY` (–µ—Å–ª–∏ –≤–∫–ª—é—á–∞–µ–º LLM)
- `APP_BASE_URL` ‚Äî –ø—É–±–ª–∏—á–Ω—ã–π URL webhook‚Äô–∞ (Vercel / —Ç—É–Ω–Ω–µ–ª—å)

## –ß–µ—Ä–Ω–æ–≤–∏–∫ —Å—Ö–µ–º—ã –ë–î (Supabase, —Å—Ö–µ–º—É –Ω–∞–∑–≤–∞—Ç—å `assistant`)
```sql
-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏ –ø—Ä–∏–≤—è–∑–∫–∞
CREATE TABLE assistant.users (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  telegram_id bigint NOT NULL,
  telegram_chat_id bigint NOT NULL,
  bitrix_user_id bigint NOT NULL,
  email text NOT NULL,
  timezone text NOT NULL DEFAULT 'Europe/Moscow',
  notifications_enabled boolean NOT NULL DEFAULT true,
  morning_time time NOT NULL DEFAULT '08:00',
  evening_time time NOT NULL DEFAULT '18:00',
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now(),
  UNIQUE (telegram_id),
  UNIQUE (email)
);

-- –û–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ –∫–æ–¥—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
CREATE TABLE assistant.auth_codes (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  telegram_id bigint NOT NULL,
  email text NOT NULL,
  code_hash text NOT NULL,
  expires_at timestamptz NOT NULL,
  attempts smallint NOT NULL DEFAULT 0,
  created_at timestamptz NOT NULL DEFAULT now()
);

-- –ö—ç—à –∑–∞–¥–∞—á Bitrix (–¥–ª—è –¥–∞–π–¥–∂–µ—Å—Ç–æ–≤/overdue)
CREATE TABLE assistant.tasks_cache (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  bitrix_task_id bigint NOT NULL,
  bitrix_user_id bigint NOT NULL,
  title text NOT NULL,
  status text NOT NULL,
  deadline timestamptz,
  updated_at timestamptz,
  raw_payload jsonb,
  UNIQUE (bitrix_task_id)
);

-- –ö—ç—à —Å–æ–±—ã—Ç–∏–π
CREATE TABLE assistant.events_cache (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  bitrix_event_id bigint NOT NULL,
  bitrix_user_id bigint NOT NULL,
  title text NOT NULL,
  start_at timestamptz NOT NULL,
  end_at timestamptz NOT NULL,
  updated_at timestamptz,
  raw_payload jsonb,
  UNIQUE (bitrix_event_id)
);

-- –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏–Ω–∫–∞
CREATE TABLE assistant.sync_state (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  bitrix_user_id bigint NOT NULL,
  entity_type text NOT NULL CHECK (entity_type IN ('task','event','user')),
  last_synced_at timestamptz,
  UNIQUE (bitrix_user_id, entity_type)
);

-- –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π/–¥–∞–π–¥–∂–µ—Å—Ç–æ–≤
CREATE TABLE assistant.notification_outbox (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  dedupe_key text NOT NULL,
  telegram_chat_id bigint NOT NULL,
  payload jsonb NOT NULL,
  sent_at timestamptz NOT NULL DEFAULT now(),
  UNIQUE (dedupe_key)
);
```
–ò–Ω–¥–µ–∫—Å—ã: –¥–æ–±–∞–≤–∏—Ç—å –ø–æ `bitrix_user_id`, `deadline`, `start_at` –¥–ª—è –≤—ã–±–æ—Ä–æ–∫; RLS –≤–∫–ª—é—á–∞—Ç—å –ø–æ—Å–ª–µ –ø–æ—è–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–∏—Å–Ω—ã—Ö —Ä–æ–ª–µ–π –∏ –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–æ—Å—Ç—É–ø–∞.

## –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å—Ä–µ–∑ (Phase 2 —Å—Ç–∞—Ä—Ç)
1) –ü–æ–¥–Ω—è—Ç—å FastAPI + aiogram —Å –∫–æ–º–∞–Ω–¥–∞–º–∏ `/start`, `/help`, `/today`.  
2) –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å `packages/bitrix_client` (webhook URL) –∏ –≤—ã—Ç—è–Ω—É—Ç—å –∑–∞–¥–∞—á–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (`tasks.task.list`/`tasks.task.get`) —Å —Ñ–∏–ª—å—Ç—Ä–æ–º –ø–æ –¥–µ–¥–ª–∞–π–Ω–∞–º.  
3) –ó–∞–ø–∏—Å–∞—Ç—å –∑–∞–¥–∞—á–∏ –≤ `assistant.tasks_cache`, –æ–±–Ω–æ–≤–∏—Ç—å `sync_state`.  
4) –û—Ç–≤–µ—Ç–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –¥–∞–π–¥–∂–µ—Å—Ç–æ–º ¬´—Å–µ–≥–æ–¥–Ω—è/–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ¬ª.  
5) –î–æ–±–∞–≤–∏—Ç—å cron endpoint `morning_digest` —Å `CRON_SECRET`.

## –î–µ–ø–ª–æ–π –Ω–∞ Vercel (Hobby)

### 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

–í Vercel Dashboard ‚Üí Project ‚Üí Settings ‚Üí Environment Variables –¥–æ–±–∞–≤—å—Ç–µ:
- `TELEGRAM_BOT_TOKEN` ‚Äî —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ –æ—Ç @BotFather
- `BITRIX24_WEBHOOK` ‚Äî –ø–æ–ª–Ω—ã–π URL incoming webhook –∏–∑ Bitrix24
- `SUPABASE_URL` ‚Äî URL –ø—Ä–æ–µ–∫—Ç–∞ Supabase
- `SUPABASE_SERVICE_ROLE_KEY` ‚Äî service-role –∫–ª—é—á Supabase
- `CRON_SECRET` ‚Äî —Å–ª—É—á–∞–π–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –¥–ª—è –∑–∞—â–∏—Ç—ã cron endpoints
- `DEFAULT_TIMEZONE` ‚Äî `Europe/Moscow` (–∏–ª–∏ –¥—Ä—É–≥–∞—è)
- `APP_BASE_URL` ‚Äî –ø—É–±–ª–∏—á–Ω—ã–π URL –≤–∞—à–µ–≥–æ Vercel –ø—Ä–æ–µ–∫—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `https://wookiee-dashboard.vercel.app`)

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram Webhook

–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è –Ω–∞ Vercel –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ webhook –≤ Telegram:

```bash
# –ó–∞–º–µ–Ω–∏—Ç–µ YOUR_BOT_TOKEN –∏ YOUR_VERCEL_URL –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
curl -X POST "https://api.telegram.org/botYOUR_BOT_TOKEN/setWebhook" \
  -d "url=https://YOUR_VERCEL_URL/webhook/telegram"
```

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å webhook:
```bash
curl "https://api.telegram.org/botYOUR_BOT_TOKEN/getWebhookInfo"
```

–£–¥–∞–ª–∏—Ç—å webhook (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ):
```bash
curl -X POST "https://api.telegram.org/botYOUR_BOT_TOKEN/deleteWebhook"
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

**üìñ –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:** –°–º. `scripts/check_vercel_deployment.md`

**–ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞:**

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ health endpoint:**
   ```bash
   curl https://YOUR_VERCEL_URL/health
   ```
   –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å: `{"status":"ok"}`

2. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ webhook (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏):**
   ```bash
   ./scripts/setup_telegram_webhook.sh
   ```
   –ò–ª–∏ –≤—Ä—É—á–Ω—É—é:
   ```bash
   curl -X POST "https://api.telegram.org/botYOUR_BOT_TOKEN/setWebhook" \
     -d "url=https://YOUR_VERCEL_URL/webhook/telegram"
   ```

3. **–û—Ç–ø—Ä–∞–≤—å—Ç–µ –±–æ—Ç—É –∫–æ–º–∞–Ω–¥—É `/start your@email.com` –≤ Telegram**

4. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ Vercel Dashboard ‚Üí Deployments ‚Üí Functions ‚Üí View Function Logs**

### 4. Cron –∑–∞–¥–∞—á–∏

Cron –∑–∞–¥–∞—á–∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ GitHub Actions (—Å–º. `.github/workflows/morning_digest.yml`, `.github/workflows/evening_digest.yml`), —Å–µ–∫—Ä–µ—Ç—ã –≤ —Ä–µ–ø–æ: `CRON_SECRET`, `APP_BASE_URL`.

### 5. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–æ—É—Ç–∏–Ω–≥–∞

`vercel.json` —Ä–æ—É—Ç–∏—Ç:
- `/health` ‚Üí `api/index.py`
- `/webhook/telegram` ‚Üí `api/index.py`
- `/jobs/morning_digest` ‚Üí `api/index.py`
- `/jobs/evening_digest` ‚Üí `api/index.py`

–í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ FastAPI `app` –∏–∑ `apps/telegram_assistant/main.py`.

## –ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞ (MVP)
- `/start <email>` ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç OTP –≤ Bitrix24 (`im.notify`), –∂–¥—ë—Ç `/code <otp>`.
- `/code <otp>` ‚Äî –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –∏ –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç Telegram ‚Üî Bitrix.
- `/today` ‚Äî –∑–∞–¥–∞—á–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è, –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ, —Å–æ–±—ã—Ç–∏—è –Ω–∞ —Å–µ–≥–æ–¥–Ω—è.
- `/help` ‚Äî —Å–ø—Ä–∞–≤–∫–∞.

## –ö—Ä–æ–Ω-–∑–∞–¥–∞—á–∏
- `/jobs/morning_digest` (08:00 Asia/Makassar, —Ç—Ä–∏–≥–≥–µ—Ä–∏—Ç—Å—è GitHub Actions) ‚Äî —à–ª—ë—Ç –¥–∞–π–¥–∂–µ—Å—Ç –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.
- `/jobs/evening_digest` (18:00 Asia/Makassar) ‚Äî –≤–µ—á–µ—Ä–Ω–∏–π –¥–∞–π–¥–∂–µ—Å—Ç.

## –°—Å—ã–ª–∫–∏ –Ω–∞ –∏—Å—Ö–æ–¥–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã
- `wookiee_ai_assistent/README.md`
- `wookiee_ai_assistent/CHECKLIST_PREPARE.md`
- `wookiee_ai_assistent/SECRETS_SETUP.md`
- `wookiee_ai_assistent/–ø–ª–∞–Ω_–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã_–∏_—Å—Ç—Ä—É–∫—Ç—É—Ä—ã_–±–æ—Ç–∞-–ø–æ–º–æ—â–Ω–∏–∫–∞_–¥–ª—è_bitrix24_440bcdf6.plan.md`

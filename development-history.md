## [2026-01-13 20:44] - Внедрение правил через .cursorrules

### Что сделано
- Создан файл `.cursorrules` в корне проекта с правилами из `AGENTS.md`
- Правила теперь доступны через стандартный механизм Cursor для работы с правилами проекта
- Файл `.cursorrules` содержит все правила работы над проектом в том же формате, что и `AGENTS.md`

### Зачем
Внедрить правила проекта через стандартный механизм Cursor (`.cursorrules`), чтобы правила автоматически применялись при работе в редакторе.

### Обновлено
- [ ] ARCHITECTURE.md roadmap
- [ ] ADR (если есть)
- [ ] Тесты (если применимо)
- [x] Документация

### Следующие шаги
- Правила теперь доступны через `.cursorrules` для Cursor и через `AGENTS.md` для других целей

## [2025-12-22 22:43] - Обновление AGENTS.md и базовых файлов

### Что сделано
- Выделен отдельный пункт для ARCHITECTURE.md и добавлен шаблон
- Объединены разделы про архивацию и временные файлы
- Обновлена нумерация и ссылки на разделы
- Созданы базовые файлы ARCHITECTURE.md, ADR.md и .CLAUDE-context.md

### Зачем
Сделать правила более структурированными и выполнить требования по наличию базовой документации.

### Обновлено
- [ ] ARCHITECTURE.md roadmap
- [ ] ADR (если есть)
- [ ] Тесты (если применимо)
- [x] Документация

### Следующие шаги
- При необходимости заполнить ARCHITECTURE.md и ADR.md содержимым

## [2026-01-13 12:15] - Старт wookiee-ai-assistant: архитектура и ADR

### Что сделано
- Прочитал базовые регламенты и существующий план бота (`wookiee_ai_assistent/*`), осмотрел Bitrix24 выгрузку.
- Добавил ADR-001 с решениями по стеку (FastAPI + aiogram, Supabase, Bitrix24 webhook, cron через внешнего провайдера).
- Создал `apps/telegram_assistant/README.md` с архитектурой, env vars и черновиком схемы БД; добавил раздел в `ARCHITECTURE.md`.

### Зачем
Зафиксировать целевой подход для Telegram ассистента в монорепо и подготовить основу для MVP и миграций.

### Обновлено
- [x] ARCHITECTURE.md roadmap
- [x] ADR (если есть)
- [ ] Тесты (если применимо)
- [x] Документация

### Следующие шаги
- Развернуть каркас `apps/telegram_assistant` (FastAPI + aiogram) и подключить `packages/bitrix_client`.
- Подготовить миграции Supabase для схемы `assistant` и RLS.
- Реализовать вертикальный срез: /start, /help, sync задач через Bitrix24 → Supabase → дайджест.

## [2026-01-13 13:00] - Вертикальный срез бота и миграции

### Что сделано
- Добавлен каркас `apps/telegram_assistant` (FastAPI + aiogram): /health, /webhook/telegram, /jobs/morning_digest, команды /start, /help, /today.
- Реализованы минимальные клиенты `packages/bitrix_client` (Bitrix webhook) и `packages/supabase_db` (Supabase schema assistant).
- Добавлена миграция `infra/supabase/migrations/202601131230_assistant_init.sql` с таблицами users/auth_codes/tasks_cache/events_cache/sync_state/notification_outbox.
- Добавлены утилиты для дат и простой юнит-тест `tests/test_dates.py`.

### Зачем
Запуск первого вертикального среза: связать Bitrix24 → Supabase → Telegram-дайджест и подготовить схему хранения.

### Обновлено
- [x] ARCHITECTURE.md roadmap
- [x] ADR (если есть)
- [x] Тесты (минимальный)
- [x] Документация

### Следующие шаги
- Настроить OTP через `im.notify` и полноценный процесс регистрации.
- Добавить RLS и политики доступа для схемы `assistant`.
- Расширить cron-дайджесты и кеширование событий календаря.

## [2026-01-13 14:30] - Деплой на Vercel, OTP, cron и RLS

### Что сделано
- Добавлен `vercel.json`, `api/index.py`, корневой `requirements.txt` для serverless деплоя FastAPI на Vercel.
- Добавлены GitHub Actions cron (`morning_digest`, `evening_digest`) для вызова `/jobs/*` без платного Vercel Cron.
- Реализован OTP через Bitrix `im.notify` (`/start` генерирует код, `/code` подтверждает), расширен дайджест с событиями календаря.
- Cron эндпоинты теперь шлют реальные дайджесты; добавлен кеш событий/задач; расширен Bitrix клиент (im.notify, события).
- Добавлена миграция RLS `202601131400_assistant_rls.sql`; обновлён README приложения.

### Зачем
Обеспечить работающий webhook на Vercel, бесплатный cron через GitHub Actions, безопасную привязку Telegram↔Bitrix с OTP и базовые политики RLS.

### Обновлено
- [x] ARCHITECTURE.md roadmap
- [x] ADR (если есть)
- [x] Тесты (минимальный)
- [x] Документация

### Следующие шаги
- Прогнать деплой на Vercel, проверить `/health` и ответы бота.
- Доработать retry/логирование в cron и добавить кэш календаря по дате/неделе.
- При необходимости усилить RLS (персональные политики под supabase auth, если появится).

## [2026-01-13 20:30] - Исправление работы бота на Vercel

### Что сделано
- Добавлена обработка ошибок в webhook endpoint (`/webhook/telegram`) с логированием и попыткой отправки сообщения пользователю при ошибке.
- Добавлен глобальный обработчик ошибок для aiogram dispatcher для перехвата необработанных исключений.
- Добавлена обработка ошибок в handlers (`/start`, `/code`) с логированием и информативными сообщениями пользователю.
- Улучшено логирование во всех критических местах (webhook, handlers, error handlers).
- Обновлена документация в `apps/telegram_assistant/README.md` с подробными инструкциями по настройке webhook и проверке работы.

### Зачем
Исправить проблемы с работой бота на Vercel: добавить обработку ошибок, чтобы бот всегда отвечал пользователю даже при ошибках, и улучшить диагностику проблем через логирование.

### Обновлено
- [ ] ARCHITECTURE.md roadmap
- [ ] ADR (если есть)
- [ ] Тесты (если применимо)
- [x] Документация

### Следующие шаги
- Проверить работу бота после деплоя на Vercel.
- При необходимости настроить webhook в Telegram через API.
- Проверить логи в Vercel Dashboard при отправке команд боту.

## [2026-01-13 21:05] - Фикс Vercel build: некорректный runtime + диагностика рантайма

### Что сделано
- Исправлен `vercel.json`: убран невалидный `runtime` для `api/index.py`, который ломал билд на Vercel.
- Добавлена минимальная диагностическая NDJSON-трассировка (без секретов) в `api/index.py` и `apps/telegram_assistant/main.py` для локального воспроизведения.

### Зачем
Vercel отклонял конфигурацию Function Runtime ещё на этапе сборки; после фикса билды должны проходить, а диагностика поможет быстро поймать ошибки инициализации бота/эндпоинтов при локальной проверке.

### Обновлено
- [ ] ARCHITECTURE.md roadmap
- [ ] ADR (если есть)
- [ ] Тесты (если применимо)
- [x] Документация

### Следующие шаги
- Перезапустить деплой на Vercel и убедиться, что build проходит.
- После успешного деплоя проверить `/health`, затем webhook и cron-эндпоинты.

## [2026-01-14 19:24] - Анализ проблем с деплоем на Vercel и предложения по решению

### Что сделано
- Исправлены конфликты зависимостей: понижены `pydantic` (2.6.3 → 2.5.3) и `httpx` (0.26.0 → 0.25.2) для совместимости с `aiogram` и `supabase`.
- Заменены `routes` на `rewrites` в `vercel.json`.
- Добавлено подробное логирование в stdout для диагностики рантайм-ошибок.
- Создан документ `DEBUGGING_SESSION_ANALYSIS.md` с полным анализом всех проблем и попыток решения.
- Создан документ `SOLUTION_PROPOSAL.md` с предложениями по решению (убрать `functions` из `vercel.json`, альтернативные платформы).

### Зачем
Диагностика проблем с деплоем на Vercel: проект не работает после деплоя (404/Internal Server Error). Последняя ошибка: `The pattern "api/index.py" defined in functions doesn't match any Serverless Functions inside the api directory.`

### Обновлено
- [ ] ARCHITECTURE.md roadmap
- [ ] ADR (если есть)
- [ ] Тесты (если применимо)
- [x] Документация (`DEBUGGING_SESSION_ANALYSIS.md`, `SOLUTION_PROPOSAL.md`)

### Следующие шаги
- Попробовать убрать секцию `functions` из `vercel.json` (Vercel автоматически обнаруживает Python файлы в `api/`).
- Если не работает — рассмотреть альтернативные платформы (Railway, Render, Fly.io) для Python FastAPI приложений.
